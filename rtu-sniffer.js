const util = require('util')
const SerialPort = require('serialport')
const modbus = require("modbus-rtu")
const config = require('config')
require('console-stamp')(console, '[HH:MM:ss.l]')

// list available serial ports
SerialPort.list(function (err, ports) {
  if (err) {
    console.error(err)
    return
  }

  ports.forEach(function (port) {
    console.log(port.comName)
  })
})

var port = '/dev/ttyUSB0'
if (/^win/.test(process.platform))
  port = 'COM3'

//create ModbusMaster instance and pass the serial port object
var master = new modbus.ModbusMaster(new SerialPort(port, {
   baudrate: 9600
}), {
   endPacketTimeout: 19,
   queueTimeout: 50,
   responseTimeout: 50
});

function parse_fractions(buffer) {
    return buffer.readUInt16BE() + buffer.readUInt16BE(2) / 65536
}

function parse_uint16(buffer) {
    return buffer.readUInt16BE()
}

function parse_float2(buffer) {
    buffer.swap16();
    return [buffer.readFloatLE(), buffer.readFloatLE(4)]
}

function parse_uint32_4(buffer) {
    //buffer.swap16();
    return [buffer.readUInt32BE(), buffer.readUInt32BE(4), buffer.readUInt32BE(8), buffer.readUInt32BE(12)]
}

function parse_uint32(buffer) {
    buffer.swap16()
    return buffer.readUInt32BE()
}

function parse_none(buffer) {
    return buffer
}

function read() {
    var result = {};
    var addr = 22
    master.readInputRegisters(addr, 30001, 2).then(function(data){
        console.log(data);
    })
}

function process_error(e) {
    var a = 1
}

//setInterval(read, 1000);

async function async_all_read() {
    var promises = []
    // LMAG
    var addr = 22
    // var promises = []
    //promises.push(master.readHoldingRegisters(addr, 30001, 8, parse_uint32).catch(console.error))
    //promises.push(master.readHoldingRegisters(addr, 30011, 8, parse_float2).catch(console.error))
    for (var r=4100; r < 65535; r++) {
        // LMAG
        var addr = 22
        result = await master.readInputRegisters(addr, r, 2, parse_none).catch(process_error)
        if (result && result.length > 0) {
          var buffer = result
          var hex_str = buffer.toString('hex').toUpperCase()
          var floatbe = buffer.readFloatBE()
          buffer.swap16()
          console.log(r, hex_str, buffer.readInt32LE(), buffer.readFloatLE(), floatbe)
        }
        if (r % 100 == 0)
            console.log(r)
    }
    //async_all_read()
}
async_all_read()
// [[19:21:15.077]] [LOG]   4112 '4096147B' 343621782 1.2684998911750533e-26
// [[19:21:15.161]] [LOG]   4113 '0A3D3E2B' 1043008061 0.16703124344348907
// [[19:21:15.240]] [LOG]   4114 '3E2B020C' 34356779 1.03034169017428e-37
// [[19:21:15.321]] [LOG]   4115 '020C4097' 1083638284 4.718999862670898    /// flowrate: m3/h
// [[19:21:15.400]] [LOG]   4116 '40970A3D' 171786391 9.112166986661468e-33
// [[19:21:15.481]] [LOG]   4117 '0A3D3F80' 1065355837 1.0003124475479126
// [[19:21:15.561]] [LOG]   4118 '3F800000' 16256 2.2779507836064226e-41
// [[19:21:15.640]] [LOG]   4119 '00000000' 0 0
// [[19:21:15.720]] [LOG]   4120 '00002C79' 746127360 3.538502824085299e-12
// [[19:21:15.801]] [LOG]   4121 '2C790000' 11385 1.5953783016338042e-41
// [[19:21:15.881]] [LOG]   4122 '00000000' 0 0
// [[19:21:15.961]] [LOG]   4123 '00000000' 0 0
// [[19:21:16.040]] [LOG]   4124 '00000303' 50528256 3.849743998942992e-37
// [[19:21:16.120]] [LOG]   4125 '03030000' 771 1.080401115994434e-42
// [[19:21:16.209]] [LOG]   4126 '00000000' 0 0
// [[19:21:16.296]] [LOG]   4127 '00000005' 327680 4.5917748078995606e-40
// [[19:21:16.379]] [LOG]   4128 '00050001' 65541 9.184250265031284e-41
// [[19:21:16.455]] [LOG]   4129 '00010000' 1 1.401298464324817e-45
// [[19:21:16.535]] [LOG]   4130 '00000001' 65536 9.183549615799121e-41
// [[19:21:16.615]] [LOG]   4131 '00010000' 1 1.401298464324817e-45
// [[19:21:16.712]] [LOG]   4132 '00000000' 0 0
// [[19:21:16.790]] [LOG]   4133 '00000000' 0 0
// [[19:21:16.871]] [LOG]   4134 '00000000' 0 0
// [[19:21:16.953]] [LOG]   4135 '00000000' 0 0
// [[19:21:17.031]] [LOG]   4136 '00000000' 0 0
// [[19:21:17.110]] [LOG]   4137 '00000000' 0 0
// [[19:21:17.189]] [LOG]   4138 '00000000' 0 0
// [[19:21:17.270]] [LOG]   4139 '00000000' 0 0
// [[19:21:17.349]] [LOG]   4140 '00000000' 0 0
// [[19:21:17.430]] [LOG]   4141 '00000000' 0 0
// [[19:21:17.509]] [LOG]   4142 '00000000' 0 0
// [[19:21:17.589]] [LOG]   4143 '00000000' 0 0
// [[19:21:17.670]] [LOG]   4144 '00000000' 0 0
// [[19:21:17.759]] [LOG]   4145 '00000000' 0 0
// [[19:21:17.844]] [LOG]   4146 '00000000' 0 0
// [[19:21:17.930]] [LOG]   4147 '00000000' 0 0
// [[19:21:18.005]] [LOG]   4148 '00000000' 0 0
// [[19:21:18.100]] [LOG]   4149 '00000000' 0 0
// [[19:21:18.181]] [LOG]   4150 '00000000' 0 0
// [[19:21:18.262]] [LOG]   4151 '00000000' 0 0
// [[19:21:18.358]] [LOG]   4152 '00000000' 0 0
// [[19:21:18.442]] [LOG]   4153 '00000000' 0 0
// [[19:21:18.532]] [LOG]   4154 '00000000' 0 0
// [[19:21:18.612]] [LOG]   4155 '00000000' 0 0
// [[19:21:18.692]] [LOG]   4156 '00000000' 0 0
// [[19:21:18.772]] [LOG]   4157 '00000000' 0 0
// [[19:21:18.851]] [LOG]   4158 '00000000' 0 0
// [[19:21:18.932]] [LOG]   4159 '00000040' 4194304 5.877471754111438e-39

// [[15:35:58.223]] [LOG]   /dev/ttyAMA0
// [[15:35:58.242]] [LOG]   /dev/ttyUSB0
// [[15:35:58.342]] [LOG]   4100
// [[15:35:59.550]] [LOG]   4112 '00000000' 0 0
// [[15:35:59.638]] [LOG]   4113 '00000000' 0 0
// [[15:35:59.717]] [LOG]   4114 '00000000' 0 0
// [[15:35:59.798]] [LOG]   4115 '00000000' 0 0
// [[15:35:59.877]] [LOG]   4116 '00000000' 0 0
// [[15:35:59.958]] [LOG]   4117 '00000000' 0 0
// [[15:36:00.038]] [LOG]   4118 '00000000' 0 0
// [[15:36:00.118]] [LOG]   4119 '00000000' 0 0
// [[15:36:00.199]] [LOG]   4120 '00002E29' 774438912 3.842615114990622e-11
// [[15:36:00.280]] [LOG]   4121 '2E290000' 11817 1.6559143952926363e-41
// [[15:36:00.358]] [LOG]   4122 '00000000' 0 0
// [[15:36:00.440]] [LOG]   4123 '00000000' 0 0
// [[15:36:00.517]] [LOG]   4124 '0000030D' 51183616 4.1436175866485635e-37
// [[15:36:00.599]] [LOG]   4125 '030D0000' 781 1.0944141006376821e-42
// [[15:36:00.687]] [LOG]   4126 '00000000' 0 0
// [[15:36:00.775]] [LOG]   4127 '00000005' 327680 4.5917748078995606e-40
// [[15:36:00.853]] [LOG]   4128 '00050001' 65541 9.184250265031284e-41
// [[15:36:00.933]] [LOG]   4129 '00010000' 1 1.401298464324817e-45
// [[15:36:01.012]] [LOG]   4130 '00000001' 65536 9.183549615799121e-41
// [[15:36:01.092]] [LOG]   4131 '00010000' 1 1.401298464324817e-45
// [[15:36:01.174]] [LOG]   4132 '00000000' 0 0
// [[15:36:01.256]] [LOG]   4133 '00000000' 0 0
// [[15:36:01.332]] [LOG]   4134 '00000000' 0 0
// [[15:36:01.414]] [LOG]   4135 '00000000' 0 0
// [[15:36:01.492]] [LOG]   4136 '00000000' 0 0
// [[15:36:01.572]] [LOG]   4137 '00000000' 0 0
// [[15:36:01.652]] [LOG]   4138 '00000000' 0 0
// [[15:36:01.732]] [LOG]   4139 '00000000' 0 0
// [[15:36:01.811]] [LOG]   4140 '00000000' 0 0
// [[15:36:01.895]] [LOG]   4141 '00000000' 0 0
// [[15:36:01.971]] [LOG]   4142 '00000000' 0 0
// [[15:36:02.052]] [LOG]   4143 '00000000' 0 0
// [[15:36:02.132]] [LOG]   4144 '00000000' 0 0
// [[15:36:02.212]] [LOG]   4145 '00000000' 0 0
// [[15:36:02.291]] [LOG]   4146 '00000000' 0 0
// [[15:36:02.375]] [LOG]   4147 '00000000' 0 0
// [[15:36:02.455]] [LOG]   4148 '00000000' 0 0
// [[15:36:02.552]] [LOG]   4149 '00000000' 0 0
// [[15:36:02.642]] [LOG]   4150 '00000000' 0 0
// [[15:36:02.722]] [LOG]   4151 '00000000' 0 0
// [[15:36:02.802]] [LOG]   4152 '00000000' 0 0
// [[15:36:02.882]] [LOG]   4153 '00000000' 0 0
// [[15:36:02.964]] [LOG]   4154 '00000000' 0 0
// [[15:36:03.042]] [LOG]   4155 '00000000' 0 0
// [[15:36:03.121]] [LOG]   4156 '00000000' 0 0
// [[15:36:03.202]] [LOG]   4157 '00000000' 0 0
// [[15:36:03.281]] [LOG]   4158 '00000000' 0 0
// [[15:36:03.362]] [LOG]   4159 '00000059' 5832704 8.173359158061218e-39

// [[19:00:03.849]] [LOG]   4112 [ <Buffer 40 97 0a 3d> ]
// [[19:00:03.936]] [LOG]   4113 [ <Buffer 0a 3d 3e 2b> ]
// [[19:00:04.017]] [LOG]   4114 [ <Buffer 3e 2b 02 0c> ]
// [[19:00:04.119]] [LOG]   4115 [ <Buffer 02 0c 40 97> ]
// [[19:00:04.208]] [LOG]   4116 [ <Buffer 40 98 00 00> ]
// [[19:00:04.295]] [LOG]   4117 [ <Buffer 00 00 3f 80> ]
// [[19:00:04.384]] [LOG]   4118 [ <Buffer 3f 80 00 00> ]
// [[19:00:04.464]] [LOG]   4119 [ <Buffer 00 00 00 00> ]
// [[19:00:04.544]] [LOG]   4120 [ <Buffer 00 00 2c 77> ]
// [[19:00:04.627]] [LOG]   4121 [ <Buffer 2c 77 00 00> ]
// [[19:00:04.703]] [LOG]   4122 [ <Buffer 00 00 00 00> ]
// [[19:00:04.784]] [LOG]   4123 [ <Buffer 00 00 00 00> ]
// [[19:00:04.863]] [LOG]   4124 [ <Buffer 00 00 03 03> ]
// [[19:00:04.945]] [LOG]   4125 [ <Buffer 03 03 00 00> ]
// [[19:00:05.023]] [LOG]   4126 [ <Buffer 00 00 00 00> ]
// [[19:00:05.105]] [LOG]   4127 [ <Buffer 00 00 00 05> ]
// [[19:00:05.183]] [LOG]   4128 [ <Buffer 00 05 00 01> ]
// [[19:00:05.263]] [LOG]   4129 [ <Buffer 00 01 00 00> ]
// [[19:00:05.343]] [LOG]   4130 [ <Buffer 00 00 00 01> ]
// [[19:00:05.500]] [LOG]   4131 [ <Buffer 00 01 00 00> ]
// [[19:00:05.582]] [LOG]   4132 [ <Buffer 00 00 00 00> ]
// [[19:00:05.663]] [LOG]   4133 [ <Buffer 00 00 00 00> ]
// [[19:00:05.742]] [LOG]   4134 [ <Buffer 00 00 00 00> ]
// [[19:00:05.822]] [LOG]   4135 [ <Buffer 00 00 00 00> ]
// [[19:00:05.902]] [LOG]   4136 [ <Buffer 00 00 00 00> ]
// [[19:00:05.982]] [LOG]   4137 [ <Buffer 00 00 00 00> ]
// [[19:00:06.063]] [LOG]   4138 [ <Buffer 00 00 00 00> ]
// [[19:00:06.142]] [LOG]   4139 [ <Buffer 00 00 00 00> ]
// [[19:00:06.221]] [LOG]   4140 [ <Buffer 00 00 00 00> ]
// [[19:00:06.302]] [LOG]   4141 [ <Buffer 00 00 00 00> ]
// [[19:00:06.381]] [LOG]   4142 [ <Buffer 00 00 00 00> ]
// [[19:00:06.466]] [LOG]   4143 [ <Buffer 00 00 00 00> ]
// [[19:00:06.543]] [LOG]   4144 [ <Buffer 00 00 00 00> ]
// [[19:00:06.622]] [LOG]   4145 [ <Buffer 00 00 00 00> ]
// [[19:00:06.701]] [LOG]   4146 [ <Buffer 00 00 00 00> ]
// [[19:00:06.781]] [LOG]   4147 [ <Buffer 00 00 00 00> ]
// [[19:00:06.861]] [LOG]   4148 [ <Buffer 00 00 00 00> ]
// [[19:00:06.941]] [LOG]   4149 [ <Buffer 00 00 00 00> ]
// [[19:00:07.021]] [LOG]   4150 [ <Buffer 00 00 00 00> ]
// [[19:00:07.117]] [LOG]   4151 [ <Buffer 00 00 00 00> ]
// [[19:00:07.196]] [LOG]   4152 [ <Buffer 00 00 00 00> ]
// [[19:00:07.277]] [LOG]   4153 [ <Buffer 00 00 00 00> ]
// [[19:00:07.356]] [LOG]   4154 [ <Buffer 00 00 00 00> ]
// [[19:00:07.436]] [LOG]   4155 [ <Buffer 00 00 00 00> ]
// [[19:00:07.516]] [LOG]   4156 [ <Buffer 00 00 00 00> ]
// [[19:00:07.596]] [LOG]   4157 [ <Buffer 00 00 00 00> ]
// [[19:00:07.677]] [LOG]   4158 [ <Buffer 00 00 00 00> ]
// [[19:00:07.756]] [LOG]   4159 [ <Buffer 00 00 00 01> ]

// [[16:32:32.993]] [LOG]   4112 [ [ 16536, -2621 ] ]
// [[16:32:33.071]] [LOG]   4113 [ [ -2621, 15917 ] ]
// [[16:32:33.150]] [LOG]   4114 [ [ 15917, 3670 ] ]
// [[16:32:33.229]] [LOG]   4115 [ [ 3670, 16536 ] ]
// [[16:32:33.310]] [LOG]   4116 [ [ 16536, -2621 ] ]
// [[16:32:33.389]] [LOG]   4117 [ [ -2621, 16256 ] ]
// [[16:32:33.470]] [LOG]   4118 [ [ 16256, 0 ] ]
// [[16:32:33.549]] [LOG]   4119 [ [ 0, 0 ] ]
// [[16:32:33.630]] [LOG]   4120 [ [ 0, 11371 ] ]
// [[16:32:33.709]] [LOG]   4121 [ [ 11371, 0 ] ]
// [[16:32:33.790]] [LOG]   4122 [ [ 0, 0 ] ]
// [[16:32:33.869]] [LOG]   4123 [ [ 0, 0 ] ]
// [[16:32:33.950]] [LOG]   4124 [ [ 0, 771 ] ]
// [[16:32:34.029]] [LOG]   4125 [ [ 771, 0 ] ]
// [[16:32:34.109]] [LOG]   4126 [ [ 0, 0 ] ]
// [[16:32:34.189]] [LOG]   4127 [ [ 0, 5 ] ]
// [[16:32:34.269]] [LOG]   4128 [ [ 5, 1 ] ]
// [[16:32:34.349]] [LOG]   4129 [ [ 1, 0 ] ]
// [[16:32:34.429]] [LOG]   4130 [ [ 0, 1 ] ]
// [[16:32:34.508]] [LOG]   4131 [ [ 1, 0 ] ]
// [[16:32:34.589]] [LOG]   4132 [ [ 0, 0 ] ]
// [[16:32:34.668]] [LOG]   4133 [ [ 0, 0 ] ]
// [[16:32:34.749]] [LOG]   4134 [ [ 0, 0 ] ]
// [[16:32:34.828]] [LOG]   4135 [ [ 0, 0 ] ]
// [[16:32:34.909]] [LOG]   4136 [ [ 0, 0 ] ]
// [[16:32:34.988]] [LOG]   4137 [ [ 0, 0 ] ]
// [[16:32:35.067]] [LOG]   4138 [ [ 0, 0 ] ]
// [[16:32:35.148]] [LOG]   4139 [ [ 0, 0 ] ]
// [[16:32:35.227]] [LOG]   4140 [ [ 0, 0 ] ]
// [[16:32:35.318]] [LOG]   4141 [ [ 0, 0 ] ]
// [[16:32:35.404]] [LOG]   4142 [ [ 0, 0 ] ]
// [[16:32:35.483]] [LOG]   4143 [ [ 0, 0 ] ]
// [[16:32:35.562]] [LOG]   4144 [ [ 0, 0 ] ]
// [[16:32:35.643]] [LOG]   4145 [ [ 0, 0 ] ]
// [[16:32:35.722]] [LOG]   4146 [ [ 0, 0 ] ]
// [[16:32:35.804]] [LOG]   4147 [ [ 0, 0 ] ]
// [[16:32:35.882]] [LOG]   4148 [ [ 0, 0 ] ]
// [[16:32:35.965]] [LOG]   4149 [ [ 0, 0 ] ]
// [[16:32:36.042]] [LOG]   4150 [ [ 0, 0 ] ]
// [[16:32:36.123]] [LOG]   4151 [ [ 0, 0 ] ]
// [[16:32:36.202]] [LOG]   4152 [ [ 0, 0 ] ]
// [[16:32:36.282]] [LOG]   4153 [ [ 0, 0 ] ]
// [[16:32:36.362]] [LOG]   4154 [ [ 0, 0 ] ]
// [[16:32:36.442]] [LOG]   4155 [ [ 0, 0 ] ]
// [[16:32:36.522]] [LOG]   4156 [ [ 0, 0 ] ]
// [[16:32:36.602]] [LOG]   4157 [ [ 0, 0 ] ]
// [[16:32:36.681]] [LOG]   4158 [ [ 0, 0 ] ]
// [[16:32:36.762]] [LOG]   4159 [ [ 0, 124 ] ]
